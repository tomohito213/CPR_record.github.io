<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>CPR Record</title>
<style>
    body {
      background-color: #87ceeb;
      font-family: "MS Gothic", sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .section {
      margin-bottom: 20px;
      padding: 10px;
      background: #00bfff;
      border-radius: 8px;
    }
    button, input, select {
      margin: 5px;
      font-weight: bold;
    }
    #log {
      width: 100%;
      height: 200px;
    }
    .timer-display {
      font-size: 24px;
      font-weight: bold;
      background: lightgreen;
      padding: 10px;
      text-align: center;
      margin: 10px 0;
      border-radius: 5px;
    }
  

/* ===== iPad-friendly UI enhancements ===== */
:root{
  --base-font: 18px;
  --h1-size: 28px;
  --btn-font: 18px;
  --btn-pad-y: 14px;
  --btn-pad-x: 18px;
  --card-radius: 12px;
}

html, body {
  font-size: var(--base-font);
  -webkit-tap-highlight-color: transparent;
}

h1 {
  font-size: var(--h1-size);
  margin: 8px 0 12px;
}

.section {
  border-radius: var(--card-radius);
  padding: 14px 14px;
  margin: 14px auto;
  max-width: 980px;       /* center on large screens */
  box-sizing: border-box;
}

.timer-display, #clock {
  font-size: 28px;
  line-height: 1.25;
  padding: 12px 16px;
  border-radius: 10px;
}

button, select, input, textarea {
  font-size: var(--btn-font);
}

button {
  padding: var(--btn-pad-y) var(--btn-pad-x);
  min-height: 48px;       /* Apple HIG touch target >=44px */
  min-width: 120px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
}

button + button { margin-left: 10px; }

/* Group buttons nicely in a responsive row */
.btn-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-top: 8px;
}

select {
  min-height: 48px;
  padding: 8px 12px;
  border-radius: 10px;
}

textarea#log {
  min-height: 260px;
  font-size: 16px;
  padding: 12px;
  border-radius: 10px;
  box-sizing: border-box;
}

/* On wider iPad landscape, increase font + layout breathing room */
@media (min-width: 768px){
  :root{
    --base-font: 19px;
    --h1-size: 30px;
    --btn-font: 19px;
  }
  .timer-display, #clock { font-size: 30px; }
}

/* On very wide (desktop or external display) */
@media (min-width: 1024px){
  :root{
    --base-font: 20px;
    --h1-size: 32px;
    --btn-font: 20px;
  }
  .timer-display, #clock { font-size: 32px; }
}


/* Patient ID input: iPad向けに大きめ */
#patient_id_input { font-size:20px; min-height:52px; }
/* 追加した「ID入力」ボタンの見た目を既存ボタンと揃える */
button { touch-action: manipulation; }
</style>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/></head>
<body>
<h1>CPR Record</h1><div class="section"><div class="btn-row"><input autocomplete="off" enterkeyhint="done" id="patient_id_input" inputmode="numeric" pattern="[0-9]*" placeholder="患者IDを入力" style="min-width:220px; padding:10px 12px; border-radius:10px;; min-height:52px; font-size:20px;" type="tel"/><button onclick="openPatientIdPad()">ID入力</button><button onclick="registerPatientId()">患者ID登録</button></div><div class="mt-12">患者ID: <span id="patient_id_display">未登録</span></div></div>
<div>
<div id="date"></div>
<div class="timer-display" id="clock"></div>
</div>
<div class="section">
<div class="btn-row"><button onclick="logEvent('記録開始')">記録開始</button><button onclick="stopBothTimers();logEvent('記録停止')">記録停止</button><button onclick="resetBothTimers();clearLog()">前回の記録を消去</button><button onclick="downloadLog()">記録表をダウンロード</button></div></div>
<div class="section">
<div class="timer-display" id="rhythmTimer">02:00</div>
<br/>
<div class="btn-row"><button onclick="startRhythmCheck()">リズムチェック開始</button><button onclick="resetRhythmTimer()">リセット</button></div><div class="btn-row"><button onclick="logEvent('リズムチェック：Asys')">Asys</button><button onclick="logEvent('リズムチェック：PEA')">PEA</button><button onclick="logEvent('リズムチェック：VF')">VF</button><button onclick="logEvent('リズムチェック：ROSC')">ROSC</button></div></div>
<div class="section">
<label>除細動(J):</label>
<div class="btn-row"><select id="shockSelect" onchange="logEvent('DC: ' + this.value + 'J 選択')">
<option disabled="" selected="">選択</option>
<option value="120">120</option>
<option value="150">150</option>
<option value="200">200</option>
<option value="360">360</option>
</select><button onclick="logEvent('ショックを実施しました');document.getElementById('shockSelect').selectedIndex=0;">ショック</button></div></div>
<div class="section">
<label>VT/VF治療薬:</label>
<div class="btn-row"><select id="drugSelect" onchange="logEvent(this.value + 'を選択')">
<option disabled="" selected="">選択</option>
<option value="アミオダロン">アミオダロン</option>
<option value="リドカイン">リドカイン</option>
</select><button onclick="logEvent('VT/VF治療薬を投与');document.getElementById('drugSelect').selectedIndex=0;">薬剤投与</button></div></div>
<div class="section">
<div class="timer-display" id="epiTimer">04:00</div>
<br/>
<p>投与回数：<span id="epiCount">0</span> 回</p>
<div class="btn-row"><button onclick="startEpiTimer()">アドレナリン投与スタート</button><button onclick="resetEpiTimer()">リセット</button></div><div class="btn-row"><button onclick="incrementEpi()">アドレナリン投与</button><button onclick="decrementEpi()">修正（-1）</button></div></div>
<textarea id="log" readonly=""></textarea>
<script>
    let logBox = document.getElementById("log");
    const rhythmDisplay = document.getElementById("rhythmTimer");
    const epiDisplay = document.getElementById("epiTimer");
    let rhythmSec = 120;
    let epiSec = 240;
    let rhythmInterval = null;
    let epiInterval = null;
    let epiCount = 0;

    function updateClock() {
      const now = new Date();
      document.getElementById("clock").textContent = now.toLocaleTimeString();
      document.getElementById("date").textContent = now.toLocaleDateString();
    }
    setInterval(updateClock, 1000);
    updateClock();

    function logEvent(text) {
      const now = new Date().toLocaleString();
      logBox.value += `${now}  ${text}\n`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    
    function clearLog() {
  patientId = '';
  var disp=document.getElementById('patient_id_display'); if(disp){disp.textContent='未登録';}
  var inp=document.getElementById('patient_id_input'); if(inp){inp.value='';}
      logBox.value = "";
      epiCount = 0;
      document.getElementById("epiCount").textContent = epiCount;
      document.querySelectorAll("select").forEach(sel => sel.selectedIndex = 0);
      document.getElementById("epiTimer").textContent = "04:00";
      document.getElementById("rhythmTimer").textContent = "02:00";
    }

    function stopRecord() {
      if (rhythmInterval) clearInterval(rhythmInterval);
      if (epiInterval) clearInterval(epiInterval);
    }



    function downloadLog() {
      const blob = new Blob([logBox.value], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = ("CPR_"+(patientId?patientId+"_":"")+"_"+new Date().toISOString().replace(/[-:T]/g,"").slice(0,12)+".txt");
      a.click();
    }

    function formatTimer(sec) {
      const m = String(Math.floor(sec / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${m}:${s}`;
    }

    function startRhythmCheck() {
      clearInterval(rhythmInterval);
      rhythmSec = 120;
      logEvent("リズムチェック開始");
      rhythmInterval = setInterval(() => {
        rhythmSec--;
        if (rhythmSec <= 0) {
          clearInterval(rhythmInterval);
          rhythmDisplay.textContent = "リズムチェック\nしてください";
        } else {
          rhythmDisplay.textContent = formatTimer(rhythmSec);
        }
      }, 1000);
    }

    function resetRhythmTimer() {
      clearInterval(rhythmInterval);
      rhythmSec = 120;
      rhythmDisplay.textContent = formatTimer(rhythmSec);
    }

    function startEpiTimer() {
      clearInterval(epiInterval);
      epiSec = 240;
      logEvent("アドレナリン投与までの時間計測開始");
      epiInterval = setInterval(() => {
        epiSec--;
        if (epiSec <= 0) {
          clearInterval(epiInterval);
          epiDisplay.textContent = "アドレナリンを\n投与してください";
        } else {
          epiDisplay.textContent = formatTimer(epiSec);
        }
      }, 1000);
    }

    function resetEpiTimer() {
      clearInterval(epiInterval);
      epiSec = 240;
      epiDisplay.textContent = formatTimer(epiSec);
    }

    function incrementEpi() {
      epiCount++;
      document.getElementById("epiCount").textContent = epiCount;
      logEvent("アドレナリン投与 +1");
    }

    function decrementEpi() {
      if (epiCount > 0) epiCount--;
      document.getElementById("epiCount").textContent = epiCount;
      logEvent("アドレナリン投与 修正 -1");
    }
  

function stopBothTimers(){
  try{ if (rhythmInterval){ clearInterval(rhythmInterval); rhythmInterval = null; } }catch(e){}
  try{ if (epiInterval){ clearInterval(epiInterval); epiInterval = null; } }catch(e){}
}

function resetBothTimers(){
  patientId = '';
  var disp=document.getElementById('patient_id_display'); if(disp){disp.textContent='未登録';}
  var inp=document.getElementById('patient_id_input'); if(inp){inp.value='';}
  try{ resetRhythmTimer(); }catch(e){}
  try{ resetEpiTimer(); }catch(e){}
}


// --- Patient ID handling ---
var patientId = "";
function registerPatientId(){
  var el = document.getElementById('patient_id_input');
  var v = (el && el.value) ? el.value.trim() : "";
  if(!v){
    // 軽いガード。空なら何もしない
    return;
  }
  patientId = v;
  var disp = document.getElementById('patient_id_display');
  if(disp){ disp.textContent = patientId; }
  if (typeof logEvent === 'function'){
    logEvent("患者ID登録: " + patientId);
  }
  // 入力欄はクリア
  el.value = "";
}


// --- Patient ID keypad helper ---
function openPatientIdPad(){
  var el = document.getElementById('patient_id_input');
  if (!el) return;
  // iOS/Safariではユーザー操作直後のfocus()のみキーボードが開くため、ここで直接focus
  el.focus({preventScroll:true});
  // 既存文字を選択して上書きしやすく
  try { el.setSelectionRange(0, el.value.length); } catch(e){}
}
</script>
</body>
</html>
