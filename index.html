<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>CPR Record</title>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
<style>
  body { background-color: #87ceeb; font-family: "MS Gothic", sans-serif; margin: 0; padding: 20px; }
  h1 { text-align: center; }
  .section { margin-bottom: 20px; padding: 10px; background: #00bfff; border-radius: 8px; }
  .btn-row { display: flex; align-items: center; flex-wrap: wrap; }
  button, input, select { margin: 5px; font-weight: bold; }
  #log { width: 100%; height: 220px; padding: 8px; }
  .timer-display { font-size: 24px; font-weight: bold; background: lightgreen; padding: 10px; text-align: center; margin: 10px 0; border-radius: 5px; white-space: pre-line; }
  label, .section-label { font-weight: bold; font-size: 18px; color: #000000; display: inline-block; margin-bottom: 6px; }
  .section button { border-radius: 12px; padding: 10px 16px; font-size: 16px; }
  #shockSelect { min-width: 100px; padding: 10px 12px; border-radius: 10px; font-size: 16px; background-color: #fff; border: 2px solid #000; }
  #patient_id_display { font-size: 20px; font-weight: bold; color: #000; }
  #date { font-size: 22px; font-weight: bold; margin-bottom: 5px; }

  /* --- Button press visual feedback --- */
  button { position: relative; transition: transform 0.06s ease, filter 0.15s ease, box-shadow 0.15s ease; }
  button:active { transform: scale(0.98); }
  button.pressed { filter: brightness(0.9); box-shadow: inset 0 0 0 2px rgba(255,255,255,0.7); }
  button.clicked { animation: btnFlash 250ms ease-out; }
  @keyframes btnFlash {
    0% { box-shadow: 0 0 0 4px rgba(255, 255, 0, 0.8) inset; }
    100% { box-shadow: none; }
  }
  button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; filter: none; }


  /* --- Print styles (A4) --- */
  @media print {
    body { background: #fff !important; padding: 10mm !important; }
    .section { background: #fff !important; border: 1px solid #ccc; }
    #log { height: auto !important; min-height: 50mm; }
    button, input, select { display: none !important; }
    h1 { margin-top: 0; }
    .timer-display { background: #eee !important; color: #000 !important; }
  }

</style>
<style>
/* === Print only the log content === */
@media print {
  body * { visibility: hidden !important; }
  #logPrint, #logPrint * {
    visibility: visible !important;
  }
  #logPrint {
    display: block !important;
    position: absolute;
    left: 0; top: 0;
    width: 100%;
    white-space: pre-wrap;
    font-size: 12pt;
    line-height: 1.4;
    padding: 16px;
    box-sizing: border-box;
  }
}
</style>
<style>
/* === Sticky Patient ID Section === */
#patientIdSection{
  background: #ffffff;
}
#patientIdBar{
  position: sticky;
  top: 0;
  z-index: 1000;
  background: #ffffff;
  padding: 6px 10px;
  border-bottom: 1px solid #e5e7eb;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  display: flex;
  align-items: center;
  gap: 8px;
}
#patientIdSection .section-label{
  margin-right: 6px;
}
@media print{
  
}
</style>
<style>
/* === Sticky Patient ID Top Bar (global) === */
#patientIdStickyBar{
  position: sticky;
  top: 0;
  z-index: 1000;
  background: #ffffff;
  padding: 6px 10px;
  border-bottom: 1px solid #e5e7eb;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  font-weight: bold;
}
@media print{
  #patientIdStickyBar{ display: none !important; }
}
</style>
<style>
/* === Patient ID Sticky Top Bar: enhanced readability === */
#patientIdStickyBar{
  position: sticky;
  top: 0;
  z-index: 1000;
  /* Colors chosen for high contrast + calm medical tone */
  background: #e0f2fe;            /* sky-100 */
  color: #0b253e;                 /* deep slate */
  border: 2px solid #0284c7;      /* sky-600 */
  border-radius: 14px;            /* rounded corners */
  padding: 10px 14px;             /* slightly larger padding */
  margin: 6px 0 10px 0;           /* breathing space */
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  font-weight: 800;
  font-size: 22px;                /* larger text for visibility */
  letter-spacing: 0.2px;
}
/* Make sure the inline "患者ID:" label stays bold */
#patientIdStickyBar .section-label{ font-weight: 900; margin-right: 8px; }
/* Responsive bump for tablets/desktops */
@media (min-width: 768px){
  #patientIdStickyBar{ font-size: 24px; padding: 12px 16px; }
}
/* Print: keep hidden (log-only printing) */
@media print{
  #patientIdStickyBar{ display:none !important; }
}
</style>
<style>
/* === Always-visible inline labels inside inputs === */
.inline-label-wrap{ position: relative; display: inline-block; }
.inline-label-wrap > input{ padding-left: var(--pad-left, 160px) !important; }
.inline-label{ position: absolute; left: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #111; font-weight: 700; opacity: 0.85; white-space: nowrap; }
@media (max-width: 480px){
  .inline-label-wrap > input{ padding-left: var(--pad-left, 130px) !important; }
  .inline-label{ left: 8px; font-size: 0.95em; }
}
</style><style>
/* Fallback: make native placeholder transparent to avoid overlap with inline label */
.inline-label-wrap > input::placeholder { color: transparent !important; }
</style><style>
/* === Compact widths for airway & ventilator numeric inputs === */
/* Use ch units so width matches expected digit count; override inline min-widths */
#tubeSize  { width: 6.5ch !important; min-width: 0 !important; }
#tubeDepth { width: 5.5ch !important; min-width: 0 !important; }

#ventVT   { width: 6ch !important;   min-width: 0 !important; }
#ventRR   { width: 4ch !important;   min-width: 0 !important; }
#ventPEEP { width: 4.5ch !important; min-width: 0 !important; }
#ventFiO2 { width: 5ch !important;   min-width: 0 !important; }
#ventPS   { width: 4.5ch !important; min-width: 0 !important; }

/* Keep comfortable tap target height; rely on existing padding */
#tubeSize, #tubeDepth,
#ventVT, #ventRR, #ventPEEP, #ventFiO2, #ventPS {
  text-align: right;
}

/* On very small screens, allow a bit more width to avoid cramped digits */
@media (max-width: 480px){
  #tubeSize  { width: 7.5ch !important; }
  #tubeDepth { width: 6.5ch !important; }
  #ventVT    { width: 7ch !important; }
  #ventRR    { width: 4.5ch !important; }
  #ventPEEP  { width: 5ch !important; }
  #ventFiO2  { width: 6ch !important; }
  #ventPS    { width: 5ch !important; }
}
</style><style>
/* === UI Simplify: calmer colors & collapsible sections === */
body { background-color: #ffffff !important; }
.section { background: #f7f7f7 !important; border: 1px solid #e5e7eb !important; }
h1 { margin-top: 4px; }

/* Section accordion */
.section.collapsible { padding: 0 !important; overflow: hidden; }
.section .section-head{
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 12px; cursor: pointer; user-select: none;
  background: #f0f3f6; border-bottom: 1px solid #e5e7eb; border-radius: 8px 8px 0 0;
}
.section .section-title{
  font-size: 18px; font-weight: 900; color: #0b253e;
}
.section .chev{ font-weight: 900; }
.section .section-body{ padding: 10px 12px; display: none; }
.section.open .section-body{ display: block; }
.section.open .chev{ transform: rotate(90deg); }

/* Compact buttons */
.section button { padding: 8px 14px !important; border-radius: 10px !important; }

/* Top tools */
#uiTools { display:flex; gap:8px; flex-wrap:wrap; margin: 6px 0 10px; }
#uiTools button{ padding:6px 10px; border-radius:10px; }

/* Reduce visual noise of timer cards */
.timer-display{ background:#eef6ff !important; border:1px solid #dbeafe; }

/* Keep sticky patient bar look but slightly softer */
#patientIdStickyBar{
  background:#e8f4ff !important; border-color:#93c5fd !important;
}
</style><style>
/* === Soft & Bright Gentle Theme ========================================= */
/* Color tokens */
:root{
  --bg: #fafcff;
  --card: #ffffff;
  --section-bg: #ffffff;
  --section-head-bg: #eaf5ff;      /* bright, gentle blue */
  --section-head-border: #cfe6ff;
  --section-border: #e8eef6;
  --text: #0b253e;
  --muted-text: #3b556f;
  --accent: #4fa2ff;               /* primary blue */
  --accent-2: #7bc8a4;             /* mint */
  --accent-3: #ffd166;             /* soft amber for warnings */
  --btn-bg: #f3f8ff;
  --btn-border: #c9ddff;
  --btn-hover: #e6f1ff;
  --btn-text: #0b253e;
  --focus: #8fc7ff;
  --chip: #eef6ff;
}

/* Page background */
body{ background: var(--bg) !important; color: var(--text); }

/* Sections */
.section{
  background: var(--section-bg) !important;
  border: 1px solid var(--section-border) !important;
  border-radius: 12px !important;
  box-shadow: 0 1px 2px rgba(12, 28, 64, 0.04);
}
.section .section-head{
  background: var(--section-head-bg) !important;
  border-bottom: 1px solid var(--section-head-border) !important;
  border-radius: 12px 12px 0 0 !important;
}
.section .section-title{
  color: var(--text) !important;
}

/* Buttons */
button{
  background: var(--btn-bg) !important;
  color: var(--btn-text) !important;
  border: 1px solid var(--btn-border) !important;
  border-radius: 12px !important;
  box-shadow: 0 1px 0 rgba(12, 28, 64, 0.03);
  transition: background 0.15s ease, transform 0.05s ease;
}
button:hover{ background: var(--btn-hover) !important; }
button:active{ transform: translateY(1px); }

/* Primary / destructive emphasis (if existing classes present) */
button.primary{ background: #eaf3ff !important; border-color: #b9d7ff !important; }
button.danger{ background: #fff3f1 !important; border-color: #ffd1c8 !important; color:#8c1d18 !important; }

/* Inputs & selects */
input[type="text"], input[type="number"], input[type="tel"], select, textarea{
  background: #ffffff !important;
  border: 1px solid #cfe3ff !important;
  border-radius: 10px !important;
  color: var(--text) !important;
  box-shadow: inset 0 1px 2px rgba(12, 28, 64, 0.03);
}
input:focus, select:focus, textarea:focus{
  outline: none !important;
  border-color: var(--focus) !important;
  box-shadow: 0 0 0 3px rgba(143,199,255,0.35) !important;
}

/* Sticky patient bar */
#patientIdStickyBar{
  background: #eaf5ff !important;
  border: 1px solid #b9d7ff !important;
  color: var(--text) !important;
}

/* Timers / info chips */
.timer-display{
  background: var(--chip) !important;
  border: 1px solid #d7eaff !important;
  color: var(--text) !important;
}
.info-chip, .tag{
  background: var(--chip) !important;
  color: var(--muted-text) !important;
  border: 1px solid #d7eaff !important;
}

/* Canvas or visual panels (if present) */
canvas, .canvas, .preview, .log-output{
  background: #ffffff !important;
  border: 1px solid #e3edf8 !important;
  border-radius: 10px !important;
  box-shadow: inset 0 1px 2px rgba(12, 28, 64, 0.03);
}

/* Links in the app */
a{ color: var(--accent); }
a:hover{ opacity: 0.9; }

/* Small polish for accordion chevron */
.section .chev{ color: var(--muted-text); }

/* Keep spacing and sizes from v4_36; do not alter layout metrics beyond visuals */
</style><style>
/* === Force canvas background to #d0e6ff === */
body canvas,
body .canvas,
body .preview,
body .log-output {
  background-color: #d0e6ff !important;
  border: 1px solid #a6ccff !important;
  border-radius: 10px !important;
  box-shadow: inset 0 1px 2px rgba(12, 28, 64, 0.05) !important;
  color: #0b253e !important;
}
</style><style>
/* === Body background changed to LightSkyBlue (#87cefa) === */
body {
  background-color: #87cefa !important;
}
</style><style>
/* === Timer display with soft mint green background (#d6f5d6) === */
.timer-display {
  background-color: #d6f5d6 !important;
  border: 1px solid #a6e3a6 !important;
  color: #0b253e !important;
  border-radius: 8px !important;
  box-shadow: inset 0 1px 2px rgba(12, 28, 64, 0.05);
}
</style><style>
/* === Readability tune (no input style changes) ======================= */
html, body {
  font-size: 16.5px !important;
  line-height: 1.45 !important;
  -webkit-text-size-adjust: 100%;
}

/* Section titles (accordion headers) */
.section .section-title{
  font-size: 19px !important;
  font-weight: 900 !important;
  letter-spacing: 0.2px;
}

/* Inline section labels (row headers) */
label.section-label{
  font-size: 16px !important;
  font-weight: 800 !important;
  color: #0b253e !important;
  letter-spacing: 0.15px;
}

/* Buttons only */
button{
  font-size: 15.5px !important;
  font-weight: 700 !important;
}

/* Patient sticky bar text */
#patientIdStickyBar{
  font-size: 16.5px !important;
  font-weight: 800 !important;
}

/* Timer emphasis */
.timer-display{
  font-size: 20px !important;
  font-weight: 800 !important;
}
.timer-display .digits, 
.timer-display .value, 
.timer-display .time, 
.timer-display strong{
  font-size: 24px !important;
  font-weight: 900 !important;
}

/* Mobile: slightly larger base for legibility */
@media (max-width: 480px){
  html, body{ font-size: 17px !important; }
  .section .section-title{ font-size: 20px !important; }
  label.section-label{ font-size: 16.5px !important; }
  button{ font-size: 16px !important; }
}
</style><style>
/* === Revert patient ID sticky bar font size to normal === */
#patientIdStickyBar{
  font-size: 14px !important;
  font-weight: 600 !important;
}
</style><style>
/* === Patient ID sticky bar: larger & bold for visibility === */
#patientIdStickyBar{
  font-size: 18px !important;
  font-weight: 900 !important;
  letter-spacing: 0.3px;
}
</style><style>
/* === Patient ID sticky bar with LightYellow background (#ffffe0) === */
#patientIdStickyBar{
  background-color: #ffffe0 !important;
  border: 1px solid #e0e0a0 !important;
  font-size: 18px !important;
  font-weight: 900 !important;
  letter-spacing: 0.3px;
  color: #0b253e !important;
}
</style><style>
/* === Unified section background color (#e6f2ff) === */
.section {
  background-color: #e6f2ff !important;
  border: 1px solid #c6defa !important;
  border-radius: 12px !important;
}
.section .section-head {
  background-color: #d0e8ff !important;
  border-bottom: 1px solid #b7dafd !important;
}
</style><style>
/* === Softer button colors: LightSteelBlue (#b0c4de) === */
button {
  background-color: #b0c4de !important;
  border: 1px solid #93acc7 !important;
  color: #0b253e !important;
  font-weight: 700 !important;
  border-radius: 10px !important;
  box-shadow: 0 1px 2px rgba(12,28,64,0.08);
  transition: background 0.2s ease, transform 0.05s ease;
}
button:hover {
  background-color: #9bb4d1 !important; /* slightly darker on hover */
}
button:active {
  transform: translateY(1px);
}
</style><style>
/* === Side-by-side layout for Rhythm Check & Adrenaline Check ========== */
.flex-row-sections {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  align-items: flex-start;
  margin-bottom: 16px;
}
.flex-row-sections > .section {
  flex: 1 1 360px;
  min-width: 320px;
}
@media (max-width: 860px){
  .flex-row-sections { display: block; }
}
</style></head>
<body>
<h1>CPR Record</h1>
<div id="patientIdStickyBar">患者ID: <span id="patient_id_display_top">未登録</span></div><div id="uiTools"><button onclick="collapseAll()">すべて折りたたみ</button><button onclick="expandAll()">すべて展開</button></div>
<!-- 患者ID -->
<div class="section" id="patientIdSection"><label class="section-label">患者登録:</label>
<div class="btn-row" style="margin-bottom:6px;">
<input autocomplete="off" enterkeyhint="done" id="patient_id_input" inputmode="numeric" pattern="[0-9]*" placeholder="患者IDを入力" style="min-width:220px; padding:10px 12px; border-radius:10px; min-height:52px; font-size:20px;" type="tel"/>
<button onclick="openPatientIdPad()">ID入力</button>
<button onclick="registerPatientId()">患者ID登録</button>
</div>
</div>
<!-- 時計 -->
<div>
<div id="date"></div>
<div class="timer-display" id="clock"></div>
</div>
<div class="section"><label class="section-label">記録開始・停止・保存:</label>
<div class="btn-row">
<button onclick="logEvent('記録開始')">記録開始</button>
<button onclick="stopBothTimers();logEvent('記録停止')">記録停止</button>
<button onclick="resetBothTimers();clearLog()">前回の記録を消去</button>
<button onclick="downloadLog()">記録表をダウンロード</button>
</div>
<div class="btn-row">
<button onclick="downloadCSV()">CSVで保存</button>
<button onclick="downloadCSVColumnar()">CSV（列形式）で保存</button>
<button onclick="downloadWithSummary()">サマリー付きで保存</button>
<button onclick="window.print()">印刷</button>
</div>
</div>
<!-- ★ 胸骨圧迫セクション -->
<div class="section" id="compressionSection">
<label class="section-label">胸骨圧迫:</label>
<div class="btn-row" style="margin-bottom:6px;">
<select id="cprMethod" style="min-width:220px; padding:10px 12px; border-radius:10px;">
<option disabled="" selected="">圧迫方法を選択</option>
<option value="用手圧迫">用手圧迫</option>
<option value="自動心臓マッサージ機">自動心臓マッサージ機</option>
</select>
<button onclick="logCompression('開始')">開始</button>
<button onclick="logCompression('停止')">停止</button>
<button onclick="logCompression('切替')">切替を記録</button>
</div>
</div>
<!-- ★ 気道管理セクション -->
<div class="section">
<label class="section-label">気道管理:</label>
<div class="btn-row">
<button onclick="logEvent('気道確保')">気道確保</button>
<button onclick="logEvent('バッグ換気開始')">バッグ換気開始</button>
<button onclick="logEvent('人工呼吸器に接続')">人工呼吸器に接続</button>
</div>
<div class="btn-row">
<input id="tubeSize" max="9.0" min="4.0" placeholder="挿管チューブ径 (mm)" step="0.5" style="min-width:180px; padding:10px 12px; border-radius:10px;" type="number"/>
<input id="tubeDepth" max="30" min="10" placeholder="固定位置 (cm)" step="0.5" style="min-width:160px; padding:10px 12px; border-radius:10px;" type="number"/>
<button onclick="logIntubation()">挿管実施を記録</button>
</div>
</div>
<!-- ★ 人工呼吸器設定セクション -->
<div class="section">
<label class="section-label">人工呼吸器 設定:</label>
<div class="btn-row">
<select id="ventMode" style="min-width:180px; padding:10px 12px; border-radius:10px;">
<option disabled="" selected="">モード選択</option>
<option value="A/C-VC">A/C-VC</option>
<option value="A/C-PC">A/C-PC</option>
<option value="SIMV-VC">SIMV-VC</option>
<option value="SIMV-PC">SIMV-PC</option>
<option value="PSV">PSV</option>
<option value="CPAP">CPAP</option>
</select>
<input id="ventVT" max="1000" min="100" placeholder="VT (mL)" step="10" style="min-width:120px; padding:10px 12px; border-radius:10px;" type="number"/>
<input id="ventRR" max="40" min="4" placeholder="RR (/min)" step="1" style="min-width:120px; padding:10px 12px; border-radius:10px;" type="number"/>
<input id="ventPEEP" max="20" min="0" placeholder="PEEP (cmH₂O)" step="1" style="min-width:150px; padding:10px 12px; border-radius:10px;" type="number"/>
<input id="ventFiO2" max="100" min="21" placeholder="FiO₂ (%)" step="1" style="min-width:120px; padding:10px 12px; border-radius:10px;" type="number"/>
<input id="ventPS" max="40" min="5" placeholder="PS (cmH₂O)" step="1" style="min-width:170px; padding:10px 12px; border-radius:10px;" type="number"/>
<button onclick="logVentSettings()">設定を記録</button>
</div>
</div>
<!-- ★ ルート確保セクション -->
<div class="section">
<label class="section-label">ルート確保:</label>
<!-- 末梢静脈路 -->
<div class="btn-row" style="flex-wrap:wrap;">
<span class="section-label">末梢静脈路：</span>
<select id="pivSide" style="min-width:100px; padding:10px 12px; border-radius:10px;">
<option disabled="" selected="">左右</option>
<option value="右">右</option>
<option value="左">左</option>
</select>
<select id="pivLimb" style="min-width:100px; padding:10px 12px; border-radius:10px;">
<option disabled="" selected="">部位</option>
<option value="上肢">上肢</option>
<option value="下肢">下肢</option>
</select>
<input id="pivSite" placeholder="具体部位（例：前腕、手背、足背など）" style="min-width:220px; padding:10px 12px; border-radius:10px;" type="text"/>
<select id="pivFluid" style="min-width:140px; padding:10px 12px; border-radius:10px;">
<option disabled="" selected="">補液選択</option>
<option value="細胞外液">細胞外液</option>
<option value="維持液">維持液</option>
<option value="生理食塩水">生理食塩水</option>
</select>
<button onclick="logPeripheralIV(this)">末梢静脈路 確保を記録</button>
</div>
<!-- 骨髄路 -->
<div class="btn-row" style="flex-wrap:wrap;">
<span class="section-label">骨髄路：</span>
<input id="ioSite" placeholder="穿刺部位（任意）" style="min-width:220px; padding:10px 12px; border-radius:10px;" type="text"/>
<select id="ioFluid" style="min-width:140px; padding:10px 12px; border-radius:10px;">
<option disabled="" selected="">補液選択</option>
<option value="細胞外液">細胞外液</option>
<option value="維持液">維持液</option>
<option value="生理食塩水">生理食塩水</option>
</select>
<button onclick="logIO(this)">骨髄路 確保を記録</button>
</div>
<!-- CVルート -->
<div class="btn-row" style="flex-wrap:wrap;">
<span class="section-label">CVルート：</span>
<select id="cvVein" style="min-width:180px; padding:10px 12px; border-radius:10px;">
<option disabled="" selected="">静脈選択</option>
<option value="内頸静脈">内頸静脈</option>
<option value="鎖骨下静脈">鎖骨下静脈</option>
<option value="大腿静脈">大腿静脈</option>
</select>
<select id="cvSide" style="min-width:100px; padding:10px 12px; border-radius:10px;">
<option disabled="" selected="">左右</option>
<option value="右">右</option>
<option value="左">左</option>
</select>
<input id="cvNote" placeholder="備考（任意：挿入長・合併症など）" style="min-width:220px; padding:10px 12px; border-radius:10px;" type="text"/>
<label style="margin-left:8px;"><input id="cvUS" type="checkbox"/> 超音波ガイド</label>
<select id="cvFluid" style="min-width:140px; padding:10px 12px; border-radius:10px;">
<option disabled="" selected="">補液選択</option>
<option value="細胞外液">細胞外液</option>
<option value="維持液">維持液</option>
<option value="生理食塩水">生理食塩水</option>
</select>
<button onclick="logCV(this)">CVルート 確保を記録</button>
</div>
<div class="btn-row" style="flex-wrap:wrap;">
<span class="section-label">Aライン：</span>
<select id="alineSite" style="min-width:180px; padding:10px 12px; border-radius:10px;">
<option disabled="" selected="">穿刺部位選択</option>
<option value="橈骨動脈">橈骨動脈</option>
<option value="大腿動脈">大腿動脈</option>
<option value="上腕動脈">上腕動脈</option>
</select>
<input id="alineNote" placeholder="備考（任意：挿入長・合併症など）" style="min-width:220px; padding:10px 12px; border-radius:10px;" type="text"/>
<button onclick="logAline(this)">Aライン 確保を記録</button>
</div><button onclick="logAlineMonitor()">動脈圧モニタリング開始</button></div>
<!-- Aライン -->
<!-- ★ リズムチェック＋除細動＋VT/VF治療薬（統合） -->
<div class="flex-row-sections"><div class="section">
<label class="section-label">リズムチェック / 除細動 / VT・VF治療薬:</label>
<div class="timer-display" id="rhythmTimer">02:00</div>
<br/>
<div class="btn-row">
<button onclick="startRhythmCheck()">リズムチェック開始</button>
<button onclick="resetRhythmTimer()">リセット</button>
</div>
<div class="btn-row">
<button onclick="logRhythm('Asys')">Asys</button>
<button onclick="logRhythm('PEA')">PEA</button>
<button onclick="logRhythm('VF')">VF</button>
<button onclick="logRhythm('VT')">VT</button>
<button onclick="logRhythm('ROSC')">ROSC</button>
</div>
<div class="btn-row" style="margin-top:6px;">
<span class="section-label">除細動(J):</span>
<select id="shockSelect" onchange="logEvent('DC: ' + this.value + 'J 選択')">
<option disabled="" selected="">選択</option>
<option value="120">120</option>
<option value="150">150</option>
<option value="200">200</option>
<option value="360">360</option>
</select>
<button onclick="logEvent('ショックを実施しました');document.getElementById('shockSelect').selectedIndex=0;">ショック</button>
</div>
<div class="btn-row" style="margin-top:6px;">
<span class="section-label">VT/VF治療薬:</span>
<select id="vtvfDrug" style="min-width:220px; padding:10px 12px; border-radius:10px;"><option disabled="True" selected="True">薬剤を選択</option><option value="アミオダロン投与">アミオダロン投与</option><option value="リドカイン投与">リドカイン投与</option><option value="ニフェカラント投与">ニフェカラント投与</option><option value="マグネシウム投与">マグネシウム投与</option></select><input id="vtvfDrugDose" placeholder="投与量 (任意)" style="min-width:120px; padding:10px 12px; border-radius:10px; margin-left:6px;" type="text"/><button onclick="logVtVfDrug()">記録</button></div>
<div class="btn-row" style="margin-top:6px;">
<span class="section-label">その他薬剤:</span>
<select id="otherDrug" style="min-width:220px; padding:10px 12px; border-radius:10px;"><option disabled="True" selected="True">薬剤を選択</option><option value="ノルアドレナリン投与">ノルアドレナリン投与</option><option value="ドパミン投与">ドパミン投与</option><option value="アトロピン投与">アトロピン投与</option><option value="メイロン投与">メイロン投与</option><option value="カルチコール投与">カルチコール投与</option></select><input id="otherDrugDose" placeholder="投与量 (任意)" style="min-width:120px; padding:10px 12px; border-radius:10px; margin-left:6px;" type="text"/><button onclick="logOtherDrug()">記録</button></div>
</div><div class="section">
<label class="section-label">アドレナリンチェック</label>
<div class="timer-display" id="epiTimer">04:00</div>
<br/>
<div class="btn-row"><span class="section-label">投与回数:</span> <span class="section-label" id="epiCount">0</span> <span class="section-label">回</span></div>
<div class="btn-row">
<button onclick="startEpiTimer()">アドレナリン投与スタート</button>
<button onclick="resetEpiTimer()">リセット</button>
</div>
<div class="btn-row">
<button onclick="incrementEpi()">アドレナリン投与</button>
<button onclick="decrementEpi()">修正（-1）</button>
</div>
</div></div>
<!-- ★ アドレナリン投与セクション -->
<label class="section-label">ログ:</label>
<textarea id="log" readonly=""></textarea>
<pre id="logPrint" style="display:none;"></pre>
<script>
  let logBox = document.getElementById("log");
  const rhythmDisplay = document.getElementById("rhythmTimer");
  const epiDisplay = document.getElementById("epiTimer");
  let rhythmSec = 120; let epiSec = 240; let rhythmInterval = null; let epiInterval = null; let epiStartAt = null; let epiFirstAt = null; let epiCount = 0; var patientId = "";

  function formatDateYYYYMMDD(date){ const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); return `${y}/${m}/${d}`; }
  function updateClock(){ const now = new Date(); document.getElementById("date").textContent = formatDateYYYYMMDD(now); document.getElementById("clock").textContent = now.toLocaleTimeString(); }
  setInterval(updateClock, 1000); updateClock();

  function appendLog(text){ if(!logBox) return; logBox.value += text + "\n"; logBox.scrollTop = logBox.scrollHeight; }
  function logEvent(text){ const now = new Date().toLocaleString(); appendLog(`${now}  ${text}`); }

  function clearLog(){ epiFirstAt=null; patientId=''; var disp=document.getElementById('patient_id_display'); if(disp){disp.textContent='未登録';} var inp=document.getElementById('patient_id_input'); if(inp){inp.value='';} logBox.value=""; epiCount=0; document.getElementById("epiCount").textContent=epiCount; document.querySelectorAll("select").forEach(sel=>sel.selectedIndex=0); document.getElementById("epiTimer").textContent="04:00"; document.getElementById("rhythmTimer").textContent="02:00"; }
  function stopRecord(){ if(rhythmInterval) clearInterval(rhythmInterval); if(epiInterval) clearInterval(epiInterval); }
  function downloadLog(){ const blob=new Blob([logBox.value],{type:"text/plain"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=("CPR_"+(patientId?patientId+"_":"")+"_"+new Date().toISOString().replace(/[-:T]/g,"").slice(0,12)+".txt"); a.click(); }

  function formatTimer(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}`; }
  function startRhythmCheck(){ clearInterval(rhythmInterval); rhythmSec=120; logEvent("リズムチェック開始"); rhythmInterval=setInterval(()=>{ rhythmSec--; if(rhythmSec<=0){ clearInterval(rhythmInterval); rhythmDisplay.textContent="リズムチェック\nしてください"; } else { rhythmDisplay.textContent=formatTimer(rhythmSec); } },1000); }
  function resetRhythmTimer(){ clearInterval(rhythmInterval); rhythmSec=120; rhythmDisplay.textContent=formatTimer(rhythmSec); }

  function startEpiTimer(){ clearInterval(epiInterval); epiSec=240; epiStartAt=new Date(); logEvent("アドレナリン投与までの時間計測開始"); epiInterval=setInterval(()=>{ epiSec--; if(epiSec<=0){ clearInterval(epiInterval); epiDisplay.textContent="アドレナリンを\n投与してください"; } else { epiDisplay.textContent=formatTimer(epiSec); } },1000); }
  function resetEpiTimer(){ clearInterval(epiInterval); epiSec=240; epiDisplay.textContent=formatTimer(epiSec); }
  function incrementEpi(){ epiCount++; document.getElementById("epiCount").textContent=epiCount; var elapsedText=""; if(!epiFirstAt){ epiFirstAt=new Date(); elapsedText="00:00"; } else { var elapsedSec=Math.max(0,Math.floor((new Date()-epiFirstAt)/1000)); elapsedText=formatTimer(elapsedSec); } logEvent("アドレナリン投与 +1（合計: "+epiCount+", 経過: "+elapsedText+"）"); restartEpiAfterDose(); }
  function decrementEpi(){ if(epiCount>0) epiCount--; document.getElementById("epiCount").textContent=epiCount; logEvent("アドレナリン投与 修正 -1（合計: "+epiCount+"）"); }

  function stopBothTimers(){ try{ if(rhythmInterval){ clearInterval(rhythmInterval); rhythmInterval=null; } }catch(e){} try{ if(epiInterval){ clearInterval(epiInterval); epiInterval=null; } }catch(e){} }
  function resetBothTimers(){ epiFirstAt=null; patientId=''; var disp=document.getElementById('patient_id_display'); if(disp){disp.textContent='未登録';} var inp=document.getElementById('patient_id_input'); if(inp){inp.value='';} try{ resetRhythmTimer(); }catch(e){} try{ resetEpiTimer(); }catch(e){} }

  function registerPatientId(){
  try{ var pidSpan = document.getElementById('patient_id_display'); if(pidSpan && pidSpan.textContent){ updatePatientIdTop(pidSpan.textContent); 
  try{
    var inp = document.getElementById('patient_id_input');
    if(inp){ setPatientIdTopBar(inp.value); }
    var span = document.getElementById('patient_id_display');
    if(span && span.textContent){ setPatientIdTopBar(span.textContent); }
  }catch(e){}
}
 }catch(e){}
 var el=document.getElementById('patient_id_input'); var v=(el&&el.value)?el.value.trim():""; if(!v){ return; } patientId=v; var disp=document.getElementById('patient_id_display'); if(disp){ disp.textContent=patientId; } logEvent("患者ID登録: "+patientId); el.value=""; }
  function openPatientIdPad(){ var el=document.getElementById('patient_id_input'); if(!el) return; el.focus({preventScroll:true}); try{ el.setSelectionRange(0, el.value.length); }catch(e){} }
  function logIntubation(){ var sizeEl=document.getElementById('tubeSize'); var depthEl=document.getElementById('tubeDepth'); var size=(sizeEl&&sizeEl.value)?sizeEl.value.trim():""; var depth=(depthEl&&depthEl.value)?depthEl.value.trim():""; var parts=[]; if(size) parts.push("ETT "+size+"mm"); if(depth) parts.push(depth+"cm固定"); var msg="挿管実施"; if(parts.length) msg+="（"+parts.join(", ")+"）"; logEvent(msg); }

  function logVentSettings(){ var modeEl=document.getElementById('ventMode'); var vtEl=document.getElementById('ventVT'); var rrEl=document.getElementById('ventRR'); var peepEl=document.getElementById('ventPEEP'); var fio2El=document.getElementById('ventFiO2'); var psEl=document.getElementById('ventPS'); var mode=(modeEl&&modeEl.value&&modeEl.value!=='モード選択')?modeEl.value:""; var vt=(vtEl&&vtEl.value)?vtEl.value.trim():""; var rr=(rrEl&&rrEl.value)?rrEl.value.trim():""; var peep=(peepEl&&peepEl.value)?peepEl.value.trim():""; var fio2=(fio2El&&fio2El.value)?fio2El.value.trim():""; var ps=(psEl&&psEl.value)?psEl.value.trim():""; var segs=[]; if(mode)segs.push(mode); if(vt)segs.push("VT "+vt+"mL"); if(rr)segs.push("RR "+rr+"/min"); if(peep)segs.push("PEEP "+peep+"cmH2O"); if(fio2)segs.push("FiO2 "+fio2+"%"); if(ps)segs.push("PS "+ps+"cmH2O"); var msg="人工呼吸器 設定"; if(segs.length) msg+="（"+segs.join(", ")+"）"; logEvent(msg); }

  function logPeripheralIV(btn){ var side=document.getElementById('pivSide'); var limb=document.getElementById('pivLimb'); var site=document.getElementById('pivSite'); var fluid=document.getElementById('pivFluid'); function doLog(){ var segs=[]; if(side&&side.value&&side.value!=='左右')segs.push(side.value); if(limb&&limb.value&&limb.value!=='部位')segs.push(limb.value); if(site&&site.value.trim())segs.push(site.value.trim()); if(fluid&&fluid.value&&fluid.value!=='補液選択')segs.push('補液: '+fluid.value); var msg="末梢静脈路確保"; if(segs.length) msg+="（"+segs.join(", ")+"）"; logEvent(msg); } if(!(side&&side.value&&side.value!=='左右')){ alert("左右を選択してください。"); return; } if(!(limb&&limb.value&&limb.value!=='部位')){ alert("部位（上肢/下肢）を選択してください。"); return; } if(!(fluid&&fluid.value&&fluid.value!=='補液選択')){ alert("補液を選択してください（細胞外液/維持液/生理食塩水）。"); return; } requireDoubleTap(btn, "piv", doLog); }

  function logIO(btn){ var site=document.getElementById('ioSite'); var fluid=document.getElementById('ioFluid'); function doLog(){ var msg="骨髄路確保"; var segs=[]; if(site&&site.value.trim())segs.push(site.value.trim()); if(fluid&&fluid.value&&fluid.value!=='補液選択')segs.push('補液: '+fluid.value); if(segs.length) msg+="（"+segs.join(", ")+"）"; logEvent(msg); } if(!(fluid&&fluid.value&&fluid.value!=='補液選択')){ alert("補液を選択してください（細胞外液/維持液/生理食塩水）。"); return; } requireDoubleTap(btn, "io", doLog); }

  function logCV(btn){ var vein=document.getElementById('cvVein'); var side=document.getElementById('cvSide'); var note=document.getElementById('cvNote'); var us=document.getElementById('cvUS'); var fluid=document.getElementById('cvFluid'); function doLog(){ var segs=[]; if(vein&&vein.value&&vein.value!=='静脈選択')segs.push(vein.value); if(side&&side.value&&side.value!=='左右')segs.push(side.value); if(us&&us.checked)segs.push("超音波ガイド"); if(note&&note.value.trim())segs.push(note.value.trim()); if(fluid&&fluid.value&&fluid.value!=='補液選択')segs.push('補液: '+fluid.value); var msg="CVルート確保"; if(segs.length) msg+="（"+segs.join(", ")+"）"; logEvent(msg); } if(!(vein&&vein.value&&vein.value!=='静脈選択')){ alert("静脈を選択してください（内頸・鎖骨下・大腿）。"); return; } if(!(side&&side.value&&side.value!=='左右')){ alert("左右を選択してください。"); return; } if(!(fluid&&fluid.value&&fluid.value!=='補液選択')){ alert("補液を選択してください（細胞外液/維持液/生理食塩水）。"); return; } requireDoubleTap(btn, "cv", doLog); }

  const _doubleTapState={};
  function requireDoubleTap(btn,key,cb){ const now=Date.now(); const last=_doubleTapState[key]||0; const windowMs=5000; if(now-last<windowMs){ _doubleTapState[key]=0; try{ btn.textContent=btn.dataset.origText||btn.textContent; }catch(e){} cb(); return; } _doubleTapState[key]=now; if(!btn.dataset.origText){ btn.dataset.origText=btn.textContent; } btn.textContent="もう一度タップで記録 (5s)"; setTimeout(()=>{ if(_doubleTapState[key] && Date.now()-_doubleTapState[key]>=windowMs){ _doubleTapState[key]=0; try{ btn.textContent=btn.dataset.origText||btn.textContent; }catch(e){} } }, windowMs+100); }

  function restartEpiAfterDose(){ try{ if(epiInterval){ clearInterval(epiInterval); epiInterval=null; } }catch(e){} epiSec=240; epiStartAt=new Date(); epiDisplay.textContent=formatTimer(epiSec); epiInterval=setInterval(()=>{ epiSec--; if(epiSec<=0){ clearInterval(epiInterval); epiInterval=null; epiDisplay.textContent="アドレナリンを\n投与してください"; } else { epiDisplay.textContent=formatTimer(epiSec); } },1000); }
  function restartRhythmAfterCheck(){ try{ if(rhythmInterval){ clearInterval(rhythmInterval); rhythmInterval=null; } }catch(e){} rhythmSec=120; rhythmDisplay.textContent=formatTimer(rhythmSec); rhythmInterval=setInterval(()=>{ rhythmSec--; if(rhythmSec<=0){ clearInterval(rhythmInterval); rhythmInterval=null; rhythmDisplay.textContent="リズムチェック\nしてください"; } else { rhythmDisplay.textContent=formatTimer(rhythmSec); } },1000); }
  function logRhythm(kind){ logEvent("リズムチェック："+kind); restartRhythmAfterCheck(); }

  // --- Button press visual feedback setup ---
  (function setupButtonPressFeedback(){
    try{
      const addListeners = (btn) => {
        btn.addEventListener('pointerdown', () => btn.classList.add('pressed'));
        const clear = () => btn.classList.remove('pressed');
        btn.addEventListener('pointerup', () => { setTimeout(clear, 120); btn.classList.add('clicked'); setTimeout(()=>btn.classList.remove('clicked'), 180); });
        btn.addEventListener('pointerleave', clear);
        btn.addEventListener('lostpointercapture', clear);
        // Also provide keyboard feedback (Space/Enter)
        btn.addEventListener('keydown', (e) => {
          if(e.code === 'Space' || e.code === 'Enter'){ btn.classList.add('pressed'); }
        });
        btn.addEventListener('keyup', (e) => {
          if(e.code === 'Space' || e.code === 'Enter'){ setTimeout(()=>btn.classList.remove('pressed'), 120); btn.classList.add('clicked'); setTimeout(()=>btn.classList.remove('clicked'), 180); }
        });
      };
      document.querySelectorAll('button').forEach(addListeners);
      // In case buttons are added later, observe DOM changes
      const obs = new MutationObserver((muts)=>{
        muts.forEach(m=>{
          m.addedNodes && m.addedNodes.forEach(n=>{
            if(n.nodeType===1){
              if(n.tagName==='BUTTON') addListeners(n);
              n.querySelectorAll && n.querySelectorAll('button').forEach(addListeners);
            }
          });
        });
      });
      obs.observe(document.documentElement, {childList:true, subtree:true});
    }catch(e){ /* no-op */ }
  })();


  // ===== Structured event capture & export =====
  (function enhanceLoggingAndExport(){
    const _orig_logEvent = window.logEvent;
    const events = []; // {ts: Date, local: string, text: string, sinceStart: number|null, sinceFirstEpi: number|null, epiCount: number}
    let recordStartAt = null;

    function toIsoLocal(dt){
      try{
        const pad = n => String(n).padStart(2,'0');
        const y = dt.getFullYear(), m=pad(dt.getMonth()+1), d=pad(dt.getDate());
        const hh=pad(dt.getHours()), mm=pad(dt.getMinutes()), ss=pad(dt.getSeconds());
        const tzMin = -dt.getTimezoneOffset();
        const sign = tzMin>=0 ? '+' : '-';
        const tzh = pad(Math.floor(Math.abs(tzMin)/60));
        const tzm = pad(Math.abs(tzMin)%60);
        return `${y}-${m}-${d}T${hh}:${mm}:${ss}${sign}${tzh}:${tzm}`;
      }catch(e){ return dt.toISOString(); }
    }

    window.logEvent = function(text){
      _orig_logEvent.call(window, text);
      try{
        const now = new Date();
        if(text.indexOf("記録開始") !== -1 && !recordStartAt){ recordStartAt = now; }
        const sinceStart = recordStartAt ? Math.max(0, Math.floor((now - recordStartAt)/1000)) : null;
        const sinceFirstEpi = (typeof epiFirstAt !== 'undefined' && epiFirstAt) ? Math.max(0, Math.floor((now - epiFirstAt)/1000)) : null;
        events.push({
          ts: now,
          local: now.toLocaleString(),
          text,
          sinceStart,
          sinceFirstEpi,
          epiCount: (typeof epiCount!=='undefined'? epiCount : null)
        });
      }catch(e){ /* no-op */ }
    };

    function normalizeCRLF(s){ return s.replace(/\r?\n/g, '\r\n'); }
    function bomize(s){ return '\uFEFF' + s; }

    function safePatientId(){
      try{
        const pid = (window.patientId && String(window.patientId).trim()) || document.getElementById('patient_id_display')?.textContent?.trim() || '';
        return pid && pid !== '未登録' ? pid : 'unknown';
      }catch(e){ return 'unknown'; }
    }

    function nowStamp(){
      const now = new Date();
      return now.toISOString().replace(/[-:T]/g,'').slice(0,12);
    }

    function fileBase(){
      const pid = safePatientId();
      const stamp = nowStamp();
      return `CPR_${pid}_${stamp}`;
    }

    function toCSV(){
      const headerLines = [
        `# patient_id: ${safePatientId()}`,
        `# exported_at: ${toIsoLocal(new Date())}`,
        `# timezone: Asia/Tokyo`
      ];
      const header = headerLines.join('\\r\\n');
      const cols = ['timestamp_iso','local_time','event','since_record_start_s','since_first_epi_s','epi_count'];
      const rows = [cols.join(',')];
      events.forEach(ev=>{
        const fields = [
          toIsoLocal(ev.ts),
          JSON.stringify(ev.local),
          JSON.stringify(ev.text),
          (ev.sinceStart!=null? ev.sinceStart : ''),
          (ev.sinceFirstEpi!=null? ev.sinceFirstEpi : ''),
          (ev.epiCount!=null? ev.epiCount : '')
        ];
        rows.push(fields.join(','));
      });
      const csv = header + '\\r\\n' + rows.join('\\r\\n');
      return bomize(normalizeCRLF(csv));
    }

    
    function triggerDownloadUTF16(name, text, mime){
      // Convert JS string to UTF-16LE with BOM for Excel/iOS compatibility
      function toUTF16LE(s){
        // Prepend BOM 0xFF 0xFE
        const buf = new Uint8Array(2 + s.length * 2);
        buf[0] = 0xFF; buf[1] = 0xFE;
        let o = 2;
        for(let i=0;i<s.length;i++){
          const c = s.charCodeAt(i);
          buf[o++] = c & 0xFF;
          buf[o++] = c >> 8;
        }
        return buf;
      }
      const u16 = toUTF16LE(text);
      const blob = new Blob([u16], {type: mime || 'text/plain;charset=utf-16le'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    }
    ;

    function buildSummary(){
      const lines = [];
      const epiTotal = (typeof epiCount!=='undefined'? epiCount : 0);
      const shocks = events.filter(e=> e.text.indexOf('ショックを実施しました')!==-1).length;
      let lastJ = null;
      for(let i=events.length-1;i>=0;i--){
        const t = events[i].text;
        const m = t.match(/DC:\s*(\d+)J/);
        if(m){ lastJ = m[1]; break; }
      }
      const rhythms = events.filter(e=> e.text.indexOf('リズムチェック：')!==-1).map(e=> e.text.split('：')[1]);
      const lastIntub = [...events].reverse().find(e=> e.text.indexOf('挿管実施')!==-1)?.text || null;
      const lastVent = [...events].reverse().find(e=> e.text.indexOf('人工呼吸器 設定')!==-1)?.text || null;
      const lastPIV = [...events].reverse().find(e=> e.text.indexOf('末梢静脈路確保')!==-1)?.text || null;
      const lastIO  = [...events].reverse().find(e=> e.text.indexOf('骨髄路確保')!==-1)?.text || null;
      const lastCV  = [...events].reverse().find(e=> e.text.indexOf('CVルート確保')!==-1)?.text || null;

      lines.push('=== CPR SUMMARY ===');
      lines.push(`患者ID: ${safePatientId()}`);
      lines.push(`出力時刻: ${toIsoLocal(new Date())} (Asia/Tokyo)`);
      lines.push('--- 主要イベント ---');
      lines.push(`アドレナリン総回数: ${epiTotal}`);
      lines.push(`除細動回数: ${shocks}` + (lastJ? `（最終選択J: ${lastJ}J）` : ''));
      if(rhythms.length){ lines.push('リズム推移: ' + rhythms.join(' → ')); }
      if(lastIntub){ lines.push('挿管: ' + lastIntub); }
      if(lastVent){ lines.push('人工呼吸器: ' + lastVent); }
      if(lastPIV){ lines.push('末梢静脈路: ' + lastPIV); }
      if(lastIO){ lines.push('骨髄路: ' + lastIO); }
      if(lastCV){ lines.push('CVルート: ' + lastCV); }
      lines.push('--- 備考 ---');
      lines.push('本サマリーは画面操作ログから自動生成されています。必要に応じて診療記録で補足してください。');
      return bomize(normalizeCRLF(lines.join('\\r\\n')));
    }

    
    function buildSummaryCSV(){
      function q(s){ return JSON.stringify(String(s==null?'':s)); }
      var pid = safePatientId();
      var exported = toIsoLocal(new Date());
      var epiTotal = (typeof epiCount!=='undefined'? epiCount : 0);
      var shocks = events.filter(function(e){ return e.text.indexOf('ショックを実施しました')!==-1; }).length;
      var lastJ = null;
      for(var i=events.length-1;i>=0;i--){
        var t = events[i].text;
        var m = t.match(/DC:\s*(\d+)J/);
        if(m){ lastJ = m[1]; break; }
      }
      var rhythms = events.filter(function(e){ return e.text.indexOf('リズムチェック：')!==-1; })
                          .map(function(e){ return e.text.split('：')[1]; });
      var lastIntub = null, lastVent = null, lastPIV = null, lastIO = null, lastCV = null;
      for(var k=events.length-1;k>=0;k--){
        var tx = events[k].text;
        if(!lastIntub && tx.indexOf('挿管実施')!==-1) lastIntub = tx;
        if(!lastVent  && tx.indexOf('人工呼吸器 設定')!==-1) lastVent = tx;
        if(!lastPIV   && tx.indexOf('末梢静脈路確保')!==-1) lastPIV = tx;
        if(!lastIO    && tx.indexOf('骨髄路確保')!==-1) lastIO = tx;
        if(!lastCV    && tx.indexOf('CVルート確保')!==-1) lastCV = tx;
      }
      var rows = [];
      rows.push('key,value');
      rows.push('patient_id,' + q(pid));
      rows.push('exported_at,' + q(exported));
      rows.push('timezone,"Asia/Tokyo"');
      rows.push('epi_total,' + q(epiTotal));
      rows.push('defib_count,' + q(shocks));
      rows.push('defib_last_j,' + q(lastJ==null?'':(lastJ+'J')));
      rows.push('rhythm_path,' + q(rhythms.length? rhythms.join(' -> ') : ''));
      rows.push('last_intubation,' + q(lastIntub==null?'':lastIntub));
      rows.push('last_vent,' + q(lastVent==null?'':lastVent));
      rows.push('last_piv,' + q(lastPIV==null?'':lastPIV));
      rows.push('last_io,' + q(lastIO==null?'':lastIO));
      rows.push('last_cv,' + q(lastCV==null?'':lastCV));
      var csv = rows.join('\r\n');
      return bomize(normalizeCRLF(csv));
    }

window.downloadWithSummary = function(){
      try{
        const rawName = fileBase() + '_raw.csv';
        const sumName = fileBase() + '_summary.csv';
        triggerDownloadUTF16(rawName, toCSV(), 'text/csv;charset=utf-16le');
        triggerDownloadUTF16(sumName, buildSummaryCSV(), 'text/csv;charset=utf-16le');
      }catch(e){
        alert('サマリー出力でエラーが発生しました');
      }
    };
  
    window.downloadCSV = function(){
      try{
        var csvText = toCSV();
        function toUTF16LEBytes(s){
          var buf = new Uint8Array(2 + s.length * 2);
          buf[0] = 0xFF; buf[1] = 0xFE;
          var o = 2;
          for(var i=0;i<s.length;i++){
            var c = s.charCodeAt(i);
            buf[o++] = c & 0xFF;
            buf[o++] = c >> 8;
          }
          return buf;
        }
        var bytes = toUTF16LEBytes(csvText);
        var blob = new Blob([bytes], {type: "text/csv;charset=utf-16le"});
        var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.style.display = "none";
        try{
          a.download = fileBase() + "_raw.csv";
        }catch(e){
          a.download = "CPR_unknown_" + (new Date().toISOString().replace(/[-:T]/g,"").slice(0,12)) + "_raw.csv";
        }
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){ URL.revokeObjectURL(a.href); document.body.removeChild(a); }, 0);
      }catch(e){
        alert("CSV保存でエラーが発生しました");
      }
    };

    function toCSVColumnar(){
      var headerLines = [
        '# patient_id: ' + safePatientId(),
        '# exported_at: ' + toIsoLocal(new Date()),
        '# timezone: Asia/Tokyo',
        '# format: columnar (events as columns)'
      ];
      var header = headerLines.join('\r\n');

      var fields = ['timestamp_iso','local_time','event','since_record_start_s','since_first_epi_s','epi_count'];

      var rows = [];
      var indices = ['field'];
      for (var i=0; i<events.length; i++){ indices.push(String(i+1)); }
      rows.push(indices.join(','));

      function toCell(v){
        if(v===null || v===undefined) return '';
        if(typeof v === 'number') return String(v);
        return JSON.stringify(String(v));
      }

      for (var f=0; f<fields.length; f++){
        var fname = fields[f];
        var r = [fname];
        for (var j=0; j<events.length; j++){
          var ev = events[j];
          var val = '';
          if(fname === 'timestamp_iso'){ val = toIsoLocal(ev.ts); }
          else if(fname === 'local_time'){ val = ev.local; }
          else if(fname === 'event'){ val = ev.text; }
          else if(fname === 'since_record_start_s'){ val = (ev.sinceStart!=null? ev.sinceStart : ''); }
          else if(fname === 'since_first_epi_s'){ val = (ev.sinceFirstEpi!=null? ev.sinceFirstEpi : ''); }
          else if(fname === 'epi_count'){ val = (ev.epiCount!=null? ev.epiCount : ''); }
          r.push(toCell(val));
        }
        rows.push(r.join(','));
      }

      var csv = header + '\r\n' + rows.join('\r\n');
      return bomize(normalizeCRLF(csv));
    }

    window.downloadCSVColumnar = function(){
      try{
        var csvText = toCSVColumnar();
        function toUTF16LEBytes(s){
          var buf = new Uint8Array(2 + s.length * 2);
          buf[0] = 0xFF; buf[1] = 0xFE;
          var o = 2;
          for(var i=0;i<s.length;i++){
            var c = s.charCodeAt(i);
            buf[o++] = c & 0xFF;
            buf[o++] = c >> 8;
          }
          return buf;
        }
        var bytes = toUTF16LEBytes(csvText);
        var blob = new Blob([bytes], {type: "text/csv;charset=utf-16le"});
        var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.style.display = "none";
        try{
          a.download = fileBase() + "_raw_columnar.csv";
        }catch(e){
          a.download = "CPR_unknown_" + (new Date().toISOString().replace(/[-:T]/g,"").slice(0,12)) + "_raw_columnar.csv";
        }
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){ URL.revokeObjectURL(a.href); document.body.removeChild(a); }, 0);
      }catch(e){
        alert("CSV保存でエラーが発生しました");
      }
    };
})();



// === Prepare log-only printing ===
(function(){
  var logBox = document.getElementById('log');
  var logPrint = document.getElementById('logPrint');
  if(!logBox || !logPrint) return;
  function syncLogToPrint(){
    try{
      logPrint.textContent = logBox.value || '';
    }catch(e){ /* no-op */ }
  }
  window.addEventListener('beforeprint', syncLogToPrint);
  // Also keep it updated periodically in case of OS-level print preview
  setInterval(syncLogToPrint, 1000);
})();



// === Sync patient ID to sticky top bar ===
(function(){
  function syncOnce(){
    var src = document.getElementById('patient_id_display');
    var dst = document.getElementById('patient_id_display_top');
    if(src && dst){ dst.textContent = src.textContent || ''; }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', syncOnce);
  }else{
    syncOnce();
  }
  try{
    var src = document.getElementById('patient_id_display');
    if(src && 'MutationObserver' in window){
      var mo = new MutationObserver(syncOnce);
      mo.observe(src, {characterData:true, childList:true, subtree:true});
    }else{
      setInterval(syncOnce, 1000);
    }
  }catch(e){ setInterval(syncOnce, 1000); }
})();



// === Helper: keep top bar ID in sync ===
function updatePatientIdTop(text){
  try{
    var top = document.getElementById('patient_id_display_top');
    if(!top) return;
    if(typeof text === 'string' && text.length){
      top.textContent = text;
      return;
    }
    // fallback: try bottom span or input
    var bottom = document.getElementById('patient_id_display');
    if(bottom && bottom.textContent){ top.textContent = bottom.textContent; return; }
    var inp = document.getElementById('patient_id_input');
    if(inp && inp.value){ top.textContent = inp.value; return; }
  }catch(e){ /* no-op */ }
}
document.addEventListener('DOMContentLoaded', function(){ updatePatientIdTop(); });



// === Ensure top bar shows the latest patient ID ===
function setPatientIdTopBar(pid){
  try{
    var top = document.getElementById('patient_id_display_top');
    if(top){ top.textContent = (pid && String(pid).trim()) ? String(pid).trim() : '未登録'; }
  }catch(e){}
}



// === Override registerPatientId with a safe, explicit implementation ===
(function(){
  var TOP_ID = 'patient_id_display_top';
  window.registerPatientId = function(){
    try{
      var el = document.getElementById('patient_id_input');
      var v = el && el.value ? String(el.value).trim() : '';
      // update global if present
      try{ window.patientId = v; }catch(e){}
      // update displays
      var top = document.getElementById(TOP_ID);
      if(top){ top.textContent = v || '未登録'; }
      var bottom = document.getElementById('patient_id_display');
      if(bottom){ bottom.textContent = v || '未登録'; }
      // log event
      try{ if(v){ logEvent('患者ID登録: ' + v); } }catch(e){}
      // clear input
      if(el){ el.value = ''; }
    }catch(e){ /* no-op */ }
  };
})();
</script>
<script>
// === Setup always-visible inline labels for numeric inputs ===
(function(){
  function wrapWithInlineLabel(input, labelText){
    if(!input || input.closest('.inline-label-wrap')) return;
    var wrap = document.createElement('span');
    wrap.className = 'inline-label-wrap';
    // Keep the same inline styles the input had (width/height)
    // Move input into wrapper
    input.parentNode.insertBefore(wrap, input);
    wrap.appendChild(input);
    var label = document.createElement('span');
    label.className = 'inline-label';
    label.textContent = labelText || input.getAttribute('placeholder') || '';
    wrap.appendChild(label);

    // Clear native placeholder to avoid double text while keeping it for a11y
    try{
      if(input.getAttribute('placeholder')){
        input.setAttribute('data-original-placeholder', input.getAttribute('placeholder'));
        input.setAttribute('aria-label', labelText || input.getAttribute('placeholder'));
        input.setAttribute('placeholder', '');
      }
    }catch(e){}

    // Measure label width to set padding
    requestAnimationFrame(function(){
      try{
        var rect = label.getBoundingClientRect();
        var pad = Math.ceil(rect.width + 18); // + some spacing
        wrap.style.setProperty('--pad-left', pad + 'px');
      }catch(e){ /* no-op */ }
    });
  }

  function setupInlineLabels(){
    var targets = [
      // 気道管理
      ['tubeSize', '挿管チューブ径 (mm)'],
      ['tubeDepth', '固定位置 (cm)'],
      // 人工呼吸器
      ['ventVT', 'VT (mL)'],
      ['ventRR', 'RR (/min)'],
      ['ventPEEP', 'PEEP (cmH₂O)'],
      ['ventFiO2', 'FiO₂ (%)'],
      ['ventPS', 'PS (cmH₂O)']
    ];
    targets.forEach(function(pair){
      var el = document.getElementById(pair[0]);
      if(el){ wrapWithInlineLabel(el, pair[1]); }
    });
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', setupInlineLabels);
  }else{
    setupInlineLabels();
  }
})();
</script><script>
// === Chest compression logging ===
function logCompression(action){
  try{
    var sel = document.getElementById('cprMethod');
    var method = (sel && sel.value && sel.value !== '圧迫方法を選択') ? sel.value : null;
    if(!method){
      alert('圧迫方法を選択してください（用手圧迫/自動心臓マッサージ機）。');
      return;
    }
    var label = '胸骨圧迫（' + method + '）: ' + action;
    logEvent(label);
  }catch(e){
    try{ logEvent('胸骨圧迫: ' + action); }catch(_){}
  }
}
</script><script>
// === Aライン logging ===
function logAline(btn){
  var site = document.getElementById('alineSite');
  var note = document.getElementById('alineNote');
  function doLog(){
    var segs = [];
    if(site && site.value && site.value !== '穿刺部位選択') segs.push(site.value);
    if(note && note.value.trim()) segs.push(note.value.trim());
    var msg = "Aライン確保";
    if(segs.length) msg += "（" + segs.join(", ") + "）";
    logEvent(msg);
  }
  if(!(site && site.value && site.value !== '穿刺部位選択')){
    alert("穿刺部位を選択してください（橈骨/大腿/上腕）。");
    return;
  }
  requireDoubleTap(btn, "aline", doLog);
}
</script><script>
// === Aライン動脈圧モニタリング logging ===
function logAlineMonitor(){
  try{
    logEvent("動脈圧モニタリング開始");
  }catch(e){}
}
</script><script>
// === VT/VF drug logging ===
function logVtVfDrug(){
  try{
    var sel = document.getElementById('vtvfDrug');
    var val = sel && sel.value && sel.value !== '薬剤を選択' ? sel.value : null;
    if(!val){
      alert('薬剤を選択してください。');
      return;
    }
    var dose=document.getElementById('vtvfDrugDose');
    var doseVal=dose&&dose.value?(' ('+dose.value+')') : '';
    logEvent(val + doseVal);
    if(dose) dose.value='';
    sel.selectedIndex = 0; // reset
  }catch(e){}
}
</script><script>
// === その他薬剤 logging ===
function logOtherDrug(){
  try{
    var sel = document.getElementById('otherDrug');
    var val = sel && sel.value && sel.value !== '薬剤を選択' ? sel.value : null;
    if(!val){
      alert('薬剤を選択してください。');
      return;
    }
    var dose=document.getElementById('otherDrugDose');
    var doseVal=dose&&dose.value?(' ('+dose.value+')') : '';
    logEvent(val + doseVal);
    if(dose) dose.value='';
    sel.selectedIndex = 0; // reset
  }catch(e){}
}
</script><script>
// === Collapsible sections & defaults ===
(function(){
  // Identify sections by comment markers and labels
  const defaultsOpen = [
    '記録操作', '胸骨圧迫', 'リズムチェック / 除細動 / VT・VF治療薬', 'アドレナリンチェック'
  ];

  function makeCollapsible(section){
    if(!section || section.classList.contains('collapsible')) return;
    const label = section.querySelector('label.section-label');
    // If section has no label, skip
    const titleText = (label && label.textContent.trim().replace(/:$/, '')) || 'セクション';
    let body = document.createElement('div');
    body.className = 'section-body';
    // Move everything except the first label into body
    const head = document.createElement('div');
    head.className = 'section-head';
    const title = document.createElement('div');
    title.className = 'section-title';
    title.textContent = titleText;
    const chev = document.createElement('div');
    chev.className = 'chev';
    chev.textContent = '›';
    head.appendChild(title); head.appendChild(chev);

    // If there's a label at top, remove it (we recreated as title)
    if(label){ label.remove(); }
    while(section.firstChild){
      const n = section.firstChild;
      if(n === head) break;
      body.appendChild(n);
    }
    section.appendChild(head);
    section.appendChild(body);
    section.classList.add('collapsible');
    // Default open/closed
    const shouldOpen = defaultsOpen.some(t => titleText.indexOf(t) !== -1);
    if(shouldOpen){ section.classList.add('open'); }
    // Restore from localStorage if exists
    try{
      const key = 'sec:'+titleText;
      const saved = localStorage.getItem(key);
      if(saved === 'open') section.classList.add('open');
      if(saved === 'closed') section.classList.remove('open');
      head.addEventListener('click', function(){
        section.classList.toggle('open');
        localStorage.setItem(key, section.classList.contains('open') ? 'open' : 'closed');
      });
    }catch(e){
      head.addEventListener('click', function(){ section.classList.toggle('open'); });
    }
  }

  document.querySelectorAll('div.section').forEach(makeCollapsible);
})();

// Global controls
function collapseAll(){
  document.querySelectorAll('div.section.collapsible').forEach(s=>s.classList.remove('open'));
}
function expandAll(){
  document.querySelectorAll('div.section.collapsible').forEach(s=>s.classList.add('open'));
}
</script><script>
/* === iPad-safe download: force UTF-8 with BOM and robust anchor click === */
(function(){
  function saveTextUTF8BOM(filename, text, mime){
    try{
      var bom = new Uint8Array([0xEF,0xBB,0xBF]);
      var blob = new Blob([bom, text], {type: (mime||'text/plain') + ';charset=utf-8'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 0);
    }catch(e){
      // Fallback: open data URL (for very old iOS)
      try{
        var data = 'data:' + (mime||'text/plain') + ';charset=utf-8,' + encodeURIComponent('\ufeff'+text);
        window.location.href = data;
      }catch(_){ alert('ダウンロードに失敗しました'); }
    }
  }

  // Keep references to original builders (not downloaders)
  var buildSummaryCSVFn = window.buildSummaryCSV || null;
  var toCSVFn = window.toCSV || null;
  var toCSVColumnarFn = window.toCSVColumnar || null;

  // Override downloaders to use BOM + safe click
  window.downloadLog = function(){
    try{
      var txt = (typeof logBox !== 'undefined' && logBox && logBox.value) ? logBox.value : '';
      var stamp = new Date().toISOString().replace(/[-:T]/g,'').slice(0,12);
      saveTextUTF8BOM('log_'+stamp+'.txt', txt, 'text/plain');
    }catch(e){ console.warn(e); }
  };

  window.downloadCSV = function(){
    try{
      if(!toCSVFn){ alert('CSV生成関数が見つかりません'); return; }
      var csv = toCSVFn();
      var stamp = new Date().toISOString().replace(/[-:T]/g,'').slice(0,12);
      saveTextUTF8BOM('log_'+stamp+'.csv', csv, 'text/csv');
    }catch(e){ console.warn(e); }
  };

  window.downloadCSVColumnar = function(){
    try{
      if(!toCSVColumnarFn){ alert('列形式CSV生成関数が見つかりません'); return; }
      var csv = toCSVColumnarFn();
      var stamp = new Date().toISOString().replace(/[-:T]/g,'').slice(0,12);
      saveTextUTF8BOM('log_columns_'+stamp+'.csv', csv, 'text/csv');
    }catch(e){ console.warn(e); }
  };

  window.downloadWithSummary = function(){
    try{
      if(!buildSummaryCSVFn){ alert('サマリー生成関数が見つかりません'); return; }
      var csv = buildSummaryCSVFn();
      var stamp = new Date().toISOString().replace(/[-:T]/g,'').slice(0,12);
      saveTextUTF8BOM('log_summary_'+stamp+'.csv', csv, 'text/csv');
    }catch(e){ console.warn(e); }
  };
})();
</script><script>
/* === Avoid iOS preview: use application/octet-stream + UTF-8 BOM ====== */
(function(){
  function saveOctetUTF8BOM(filename, text){
    try{
      var bom = new Uint8Array([0xEF,0xBB,0xBF]);
      var blob = new Blob([bom, text], {type: 'application/octet-stream'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.setAttribute('download', filename);
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 0);
    }catch(e){
      try{
        var data = 'data:application/octet-stream;charset=utf-8,' + encodeURIComponent('\ufeff'+text);
        window.location.href = data;
      }catch(_){ alert('ダウンロードで問題が発生しました'); }
    }
  }

  // Rebind downloaders to use octet-stream (no preview)
  if(typeof window.downloadLog === 'function'){
    var orig_txt = window.downloadLog;
    window.downloadLog = function(){
      try{
        var txt = (typeof logBox !== 'undefined' && logBox && logBox.value) ? logBox.value : (window.toPlainText ? window.toPlainText() : '');
        var stamp = new Date().toISOString().replace(/[-:T]/g,'').slice(0,12);
        saveOctetUTF8BOM('log_'+stamp+'.txt', txt);
      }catch(e){ try{ orig_txt(); }catch(_){} }
    };
  }

  if(typeof window.downloadCSV === 'function'){
    var orig_csv = window.downloadCSV;
    window.downloadCSV = function(){
      try{
        var csv = (window.toCSV && window.toCSV()) || '';
        var stamp = new Date().toISOString().replace(/[-:T]/g,'').slice(0,12);
        saveOctetUTF8BOM('log_'+stamp+'.csv', csv);
      }catch(e){ try{ orig_csv(); }catch(_){} }
    };
  }

  if(typeof window.downloadCSVColumnar === 'function'){
    var orig_col = window.downloadCSVColumnar;
    window.downloadCSVColumnar = function(){
      try{
        var csv = (window.toCSVColumnar && window.toCSVColumnar()) || '';
        var stamp = new Date().toISOString().replace(/[-:T]/g,'').slice(0,12);
        saveOctetUTF8BOM('log_columns_'+stamp+'.csv', csv);
      }catch(e){ try{ orig_col(); }catch(_){} }
    };
  }

  if(typeof window.downloadWithSummary === 'function'){
    var orig_sum = window.downloadWithSummary;
    window.downloadWithSummary = function(){
      try{
        var csv = (window.buildSummaryCSV && window.buildSummaryCSV()) || '';
        var stamp = new Date().toISOString().replace(/[-:T]/g,'').slice(0,12);
        saveOctetUTF8BOM('log_summary_'+stamp+'.csv', csv);
      }catch(e){ try{ orig_sum(); }catch(_){} }
    };
  }
})();
</script></body>
</html>
